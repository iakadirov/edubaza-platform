// Prisma Schema для EduBaza.uz Platform
// Модульная структура с поддержкой микросервисной архитектуры

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH MODULE
// ============================================

model User {
  id        String   @id @default(uuid())
  phone     String   @unique @db.VarChar(15)
  name      String?  @db.VarChar(100)
  email     String?  @unique @db.VarChar(255)

  // Profile info
  specialty TeacherSpecialty?
  school    String?  @db.VarChar(200)

  // Subscription
  subscriptionPlan      SubscriptionPlan @default(FREE)
  subscriptionExpiresAt DateTime?
  subscriptionStartedAt DateTime?

  // Limits (stored as JSON for flexibility)
  limits    Json     @default("{\"worksheetsPerMonth\": 10, \"templatesAccess\": 3, \"taskTypesAccess\": 15}")

  // Usage tracking
  usage     Json     @default("{\"worksheetsThisMonth\": 0, \"lastResetAt\": null}")

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  isActive  Boolean  @default(true)

  // Relations
  worksheets Worksheet[]
  payments   Payment[]

  @@index([phone])
  @@index([subscriptionPlan])
  @@map("users")
}

enum SubscriptionPlan {
  FREE
  PRO
  SCHOOL
}

enum TeacherSpecialty {
  PRIMARY_SCHOOL        // Начальные классы (1-4)
  MATHEMATICS          // Математика
  RUSSIAN_LANGUAGE     // Русский язык
  UZBEK_LANGUAGE       // Узбекский язык
  ENGLISH_LANGUAGE     // Английский язык
  PHYSICS              // Физика
  CHEMISTRY            // Химия
  BIOLOGY              // Биология
  GEOGRAPHY            // География
  HISTORY              // История
  LITERATURE           // Литература
  INFORMATICS          // Информатика
  PHYSICAL_EDUCATION   // Физическая культура
  MUSIC                // Музыка
  ART                  // Изобразительное искусство
  OTHER                // Другое
}

// ============================================
// WORKSHEETS MODULE
// ============================================

model Worksheet {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Info
  subject     String   @db.VarChar(50)    // Matematika, Fizika, etc.
  grade       Int                          // 1-11
  topicUz     String   @db.Text           // Mavzu (o'zbek)
  topicRu     String?  @db.Text           // Mavzu (русский) - optional

  // Generation Config (stored as JSON)
  config      Json                         // {taskCount, difficulty, taskTypes, tone, etc.}

  // Generated Content
  tasks       Json                         // Generated tasks array

  // Template & PDF
  templateId  String?
  template    Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  pdfUrl      String?   @db.Text
  pdfGeneratedAt DateTime?

  // Metadata
  status      WorksheetStatus @default(DRAFT)
  generatedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  viewCount   Int      @default(0)

  @@index([userId])
  @@index([subject])
  @@index([grade])
  @@index([generatedAt])
  @@map("worksheets")
}

enum WorksheetStatus {
  DRAFT
  GENERATING
  COMPLETED
  FAILED
}

// ============================================
// TEMPLATES MODULE
// ============================================

model Template {
  id            String   @id @default(uuid())

  // Template Info
  nameUz        String   @db.VarChar(100)
  nameRu        String?  @db.VarChar(100)
  description   String?  @db.Text
  previewUrl    String   @db.Text

  // Template Files
  htmlTemplate  String   @db.Text
  cssStyles     String   @db.Text

  // Access Control
  isPremium     Boolean  @default(false)
  category      String?  @db.VarChar(50)  // classic, modern, colorful

  // Metadata
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  worksheets    Worksheet[]

  @@index([isPremium])
  @@index([isActive])
  @@map("templates")
}

// ============================================
// CURRICULUM/TOPICS MODULE
// ============================================

model CurriculumTopic {
  id          String   @id @default(uuid())

  // Topic Info
  subject     String   @db.VarChar(50)
  grade       Int
  topicUz     String   @db.Text
  topicRu     String?  @db.Text

  // Additional Info
  description String?  @db.Text
  keywords    String[] // For search
  quarter     Int?     // 1-4 chorak

  // Metadata
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  predefinedTasks PredefinedTask[]

  @@unique([subject, grade, topicUz])
  @@index([subject, grade])
  @@index([keywords])
  @@map("curriculum_topics")
}

// ============================================
// PREDEFINED TASKS MODULE
// ============================================

model PredefinedTask {
  id          String   @id @default(uuid())

  // Task Classification
  subject     String   @db.VarChar(50)    // MATHEMATICS, PHYSICS, etc.
  grade       Int                          // 1-11
  topicId     String?                      // Link to CurriculumTopic (optional)
  topic       CurriculumTopic? @relation(fields: [topicId], references: [id], onDelete: SetNull)

  // Task Type & Difficulty
  taskType    TaskType                     // TEST, PROBLEM, QUESTION, FILL_BLANK
  difficulty  Difficulty                   // EASY, MEDIUM, HARD

  // Task Content (Uzbek Latin)
  question    String   @db.Text           // Savol matni

  // Task-specific fields (JSON for flexibility)
  content     Json                         // Different structure for each taskType:
                                           // TEST: {options: string[], correctAnswer: number}
                                           // PROBLEM: {solution: string, answer: string}
                                           // QUESTION: {sampleAnswer?: string, rubric?: string}
                                           // FILL_BLANK: {blanks: string[], answers: string[]}

  // Metadata
  tags        String[] @default([])        // Keywords for search
  isActive    Boolean  @default(true)
  quality     Int      @default(5)         // 1-10 rating
  usageCount  Int      @default(0)         // How many times used

  // Admin info
  createdBy   String?  @db.VarChar(100)   // Admin username
  reviewedBy  String?  @db.VarChar(100)   // Who reviewed/approved

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([subject, grade, taskType])
  @@index([difficulty])
  @@index([isActive])
  @@index([quality])
  @@index([topicId])
  @@map("predefined_tasks")
}

enum TaskType {
  TEST          // Testlar (javob tanlash)
  PROBLEM       // Masalalar (yechim bilan)
  QUESTION      // Savollar (ochiq)
  FILL_BLANK    // Boʻsh joyni toʻldirish
}

enum Difficulty {
  EASY    // Oson
  MEDIUM  // Oʻrta
  HARD    // Qiyin
}

// ============================================
// PAYMENTS MODULE
// ============================================

model Payment {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Payment Info
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("UZS") @db.VarChar(3)

  // Plan Info
  planType        SubscriptionPlan
  durationMonths  Int      @default(1)

  // Payment Provider
  paymentMethod   PaymentMethod
  transactionId   String?  @unique @db.VarChar(255)

  // Payment Data (provider-specific)
  paymentData     Json?

  // Status
  status          PaymentStatus @default(PENDING)

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  paidAt          DateTime?
  failedAt        DateTime?
  failureReason   String?  @db.Text

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

enum PaymentMethod {
  CLICK
  PAYME
  UZCARD
  HUMO
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

// ============================================
// SYSTEM/ANALYTICS (Optional)
// ============================================

model SystemLog {
  id        String   @id @default(uuid())

  level     LogLevel
  module    String   @db.VarChar(50)
  message   String   @db.Text
  metadata  Json?

  userId    String?
  ipAddress String?  @db.VarChar(45)
  userAgent String?  @db.Text

  createdAt DateTime @default(now())

  @@index([level])
  @@index([module])
  @@index([createdAt])
  @@map("system_logs")
}

enum LogLevel {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// ============================================
// FUTURE: Analytics (для фазы 2)
// ============================================

// model Analytics {
//   id              String   @id @default(uuid())
//   userId          String?
//   eventType       String   @db.VarChar(50)
//   eventData       Json
//   sessionId       String?
//   createdAt       DateTime @default(now())
//
//   @@index([eventType])
//   @@index([createdAt])
//   @@map("analytics")
// }
