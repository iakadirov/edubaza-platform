import React from 'react';
import { Document, Page, Text, View, Image, Svg, Path } from '@react-pdf/renderer';
import { commonStyles } from '../styles/common';
import { WatermarkOptimized } from '../components/WatermarkOptimized';
import {
  SingleChoiceTask,
  MultipleChoiceTask,
  TrueFalseTask,
  ShortAnswerTask,
  FillBlanksTask,
  MatchingTask,
  EssayTask,
} from '../components/TaskComponents';

interface Task {
  id: string;
  content: any;
}

interface WorksheetData {
  title: string;
  subject?: string;
  grade?: number;
  quarter?: number;
  week?: number;
  tasks: Task[];
  showWatermark?: boolean;
}

const TaskRenderer: React.FC<{ task: Task; index: number }> = ({ task, index }) => {
  const taskType = task.content.task_type?.toUpperCase();

  let TaskComponent;
  switch (taskType) {
    case 'SINGLE_CHOICE':
      TaskComponent = SingleChoiceTask;
      break;
    case 'MULTIPLE_CHOICE':
      TaskComponent = MultipleChoiceTask;
      break;
    case 'TRUE_FALSE':
      TaskComponent = TrueFalseTask;
      break;
    case 'SHORT_ANSWER':
      TaskComponent = ShortAnswerTask;
      break;
    case 'FILL_BLANKS':
      TaskComponent = FillBlanksTask;
      break;
    case 'MATCHING':
      TaskComponent = MatchingTask;
      break;
    case 'ESSAY':
      TaskComponent = EssayTask;
      break;
    default:
      return null;
  }

  return (
    <View style={commonStyles.taskCard}>
      <View style={commonStyles.taskHeader}>
        <Text style={commonStyles.taskNumber}>{index + 1}</Text>
        <View style={commonStyles.taskContent}>
          <TaskComponent content={task.content} />
        </View>
      </View>
    </View>
  );
};

export const WorksheetPDF: React.FC<{ data: WorksheetData }> = ({ data }) => {
  return (
    <Document>
      <Page size="A4" style={commonStyles.page}>
        {/* Watermark - SVG-based, renders on all pages with 'fixed' attribute */}
        {data.showWatermark !== false && <WatermarkOptimized mode="diagonal" />}

        {/* Header */}
        <View style={commonStyles.header}>
          <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center' }}>
            {/* Left: Title and Student info */}
            <View style={{ flexDirection: 'column', gap: 15, flex: 1 }}>
              {/* Title - aligned left */}
              <Text style={{ fontSize: 14, fontWeight: 600, color: '#000000' }}>
                {data.title}
              </Text>

              {/* Student info - horizontal layout */}
              <View style={{ flexDirection: 'row', alignItems: 'center', gap: 4 }}>
                {/* Ism */}
                <View style={{ flexDirection: 'row', alignItems: 'center', gap: 4 }}>
                  <Text style={{ fontSize: 10, fontWeight: 500, color: '#000000' }}>Ism:</Text>
                  <View style={{
                    width: 180,
                    height: 20,
                    borderBottom: 1,
                    borderColor: '#060606'
                  }} />
                </View>

                {/* Sinf */}
                <View style={{ flexDirection: 'row', alignItems: 'center', gap: 4 }}>
                  <Text style={{ fontSize: 10, fontWeight: 500, color: '#000000' }}>Sinf:</Text>
                  <View style={{
                    width: 56,
                    height: 20,
                    borderBottom: 1,
                    borderColor: '#060606'
                  }} />
                </View>
              </View>
            </View>

            {/* Right: Branding box */}
            <View style={{
              flexDirection: 'column',
              justifyContent: 'center',
              alignItems: 'flex-end',
              padding: 8,
              paddingHorizontal: 7,
              gap: 6,
              width: 100,
              backgroundColor: '#EBFBFF',
              borderWidth: 0.5,
              borderColor: '#D4EFF5',
              borderRadius: 6,
            }}>
              {/* Logo */}
              <Svg width="64.41" height="12.41" viewBox="0 0 65 13">
                <Path d="M4.35845 3.41024C5.74473 3.41024 6.83711 3.9093 7.63561 4.90742C8.32734 5.76248 8.65703 6.8173 8.62467 8.07186C8.61592 8.41122 8.32675 8.667 7.98729 8.667H2.80984C2.7011 8.667 2.62135 8.77004 2.66203 8.87089C2.76508 9.12636 2.93131 9.34675 3.16071 9.53203C3.44905 9.76493 3.82058 9.90355 4.27527 9.94791C4.59689 9.97009 4.90742 9.92573 5.20685 9.81483C5.3642 9.75073 5.49858 9.67437 5.61 9.58577C5.78869 9.44366 5.99407 9.31577 6.22238 9.31577H7.65903C8.09891 9.31577 8.41982 9.73955 8.21345 10.128C7.92635 10.6684 7.51747 11.113 6.98683 11.4617C6.2216 11.9719 5.32884 12.2269 4.30854 12.2269C2.95554 12.2269 1.89643 11.8055 1.1312 10.9627C0.377067 10.1087 0 9.0607 0 7.81859C0 6.55431 0.404792 5.50629 1.21438 4.67452C2.03505 3.83167 3.08308 3.41024 4.35845 3.41024ZM4.34182 5.67264C3.93148 5.67264 3.57105 5.77245 3.26052 5.97207C3.02959 6.11748 2.85143 6.30575 2.72604 6.53691C2.6709 6.63855 2.75093 6.75393 2.86656 6.75393H5.80669C5.92056 6.75393 6.00077 6.64164 5.95127 6.53909C5.6725 5.96146 5.13602 5.67264 4.34182 5.67264Z" fill="#1761FF"/>
                <Path d="M15.6064 4.67452C15.6306 4.67452 15.6502 4.6549 15.6502 4.63069V1.92138C15.6502 0.860231 16.5104 0 17.5716 0C17.9253 0 18.212 0.286743 18.212 0.640459V11.453C18.212 11.7606 18.0012 12.0281 17.7021 12.1L16.9637 12.2775C16.6778 12.3462 16.3807 12.2192 16.2329 11.965L15.6678 10.9929C15.6569 10.9742 15.6368 10.9627 15.6152 10.9627C15.5954 10.9627 15.5769 10.9723 15.5653 10.9883C15.3013 11.3536 14.9525 11.65 14.519 11.8776C14.0754 12.1105 13.5763 12.2269 13.0218 12.2269C11.8906 12.2269 10.9646 11.8111 10.2437 10.9793C9.53394 10.1364 9.17905 9.07179 9.17905 7.78532C9.17905 6.48777 9.53948 5.4342 10.2603 4.62462C10.9923 3.81503 11.9128 3.41024 13.0218 3.41024C13.5763 3.41024 14.0754 3.52668 14.519 3.75958C14.9553 3.98865 15.3058 4.28746 15.5705 4.65602C15.5788 4.66758 15.5921 4.67452 15.6064 4.67452ZM12.3398 6.40459C11.9738 6.77057 11.7908 7.2419 11.7908 7.81859C11.7908 8.39528 11.9738 8.87216 12.3398 9.24923C12.7057 9.61521 13.166 9.7982 13.7205 9.7982C14.275 9.7982 14.7352 9.60966 15.1012 9.2326C15.4672 8.85553 15.6502 8.38419 15.6502 7.81859C15.6502 7.26408 15.4672 6.7983 15.1012 6.42123C14.7463 6.03307 14.2861 5.83899 13.7205 5.83899C13.166 5.83899 12.7057 6.02753 12.3398 6.40459Z" fill="#1761FF"/>
                <Path d="M19.1027 8.06812V5.61026C19.1027 4.54222 19.9685 3.6764 21.0365 3.6764C21.3925 3.6764 21.6811 3.96501 21.6811 4.32102V8.03485C21.6811 8.51173 21.8142 8.91652 22.0804 9.24923C22.3465 9.57085 22.7347 9.73166 23.2449 9.73166C23.755 9.73166 24.1432 9.57085 24.4093 9.24923C24.6755 8.91652 24.8086 8.51173 24.8086 8.03485V5.61026C24.8086 4.54222 25.6744 3.6764 26.7424 3.6764C27.0984 3.6764 27.387 3.96501 27.387 4.32102V8.06812C27.387 9.35459 27.0155 10.3693 26.2725 11.1124C25.5405 11.8554 24.5313 12.2269 23.2449 12.2269C21.9695 12.2269 20.9603 11.8554 20.2172 11.1124C19.4742 10.3693 19.1027 9.35459 19.1027 8.06812Z" fill="#1761FF"/>
                <Path d="M33.3872 3.41024C34.4962 3.41024 35.4112 3.81503 36.132 4.62462C36.864 5.4342 37.2299 6.48777 37.2299 7.78532C37.2299 9.07179 36.8695 10.1364 36.1487 10.9793C35.4389 11.8111 34.5184 12.2269 33.3872 12.2269C32.8327 12.2269 32.3336 12.1105 31.89 11.8776C31.4565 11.65 31.1077 11.3536 30.8437 10.9883C30.8321 10.9723 30.8136 10.9627 30.7938 10.9627C30.7722 10.9627 30.7521 10.9742 30.7412 10.9929L30.1761 11.965C30.0283 12.2192 29.7312 12.3462 29.4453 12.2775L28.7069 12.1C28.4078 12.0281 28.197 11.7606 28.197 11.453V0.64046C28.197 0.286744 28.4837 0 28.8374 0C29.8986 0 30.7588 0.860231 30.7588 1.92138V4.63069C30.7588 4.6549 30.7784 4.67452 30.8026 4.67452C30.8169 4.67452 30.8302 4.66758 30.8385 4.65602C31.1032 4.28746 31.4537 3.98865 31.89 3.75958C32.3336 3.52668 32.8327 3.41024 33.3872 3.41024ZM31.3078 9.2326C31.6738 9.60966 32.134 9.7982 32.6885 9.7982C33.243 9.7982 33.7033 9.61521 34.0692 9.24923C34.4352 8.87216 34.6182 8.39528 34.6182 7.81859C34.6182 7.2419 34.4352 6.77057 34.0692 6.40459C33.7033 6.02753 33.243 5.83899 32.6885 5.83899C32.1229 5.83899 31.6571 6.03307 31.2911 6.42123C30.9363 6.7983 30.7588 7.26408 30.7588 7.81859C30.7588 8.38419 30.9418 8.85553 31.3078 9.2326Z" fill="#1761FF"/>
                <Path d="M44.224 4.67452C44.2457 4.67452 44.2657 4.66299 44.2766 4.64426L44.4297 4.38098C44.822 3.70618 45.6107 3.36887 46.3697 3.55131C46.6343 3.61492 46.8209 3.85163 46.8209 4.12382V11.453C46.8209 11.7606 46.61 12.0281 46.311 12.1L45.5725 12.2775C45.2866 12.3462 44.9895 12.2192 44.8417 11.965L44.2766 10.9929C44.2657 10.9742 44.2457 10.9627 44.224 10.9627C44.2042 10.9627 44.1857 10.9723 44.1741 10.9883C43.9101 11.3536 43.5613 11.65 43.1278 11.8776C42.6842 12.1105 42.1851 12.2269 41.6306 12.2269C40.5216 12.2269 39.6011 11.8222 38.8692 11.0126C38.1483 10.203 37.7879 9.14942 37.7879 7.85186C37.7879 6.5654 38.1428 5.50629 38.8525 4.67452C39.5734 3.83167 40.4994 3.41024 41.6306 3.41024C42.1851 3.41024 42.6842 3.52668 43.1278 3.75958C43.5613 3.98717 43.9101 4.2836 44.1741 4.64886C44.1857 4.66489 44.2042 4.67452 44.224 4.67452ZM42.3293 9.7982C42.8949 9.7982 43.3552 9.60966 43.7101 9.2326C44.076 8.84444 44.259 8.37311 44.259 7.81859C44.259 7.25299 44.076 6.78166 43.7101 6.40459C43.3441 6.02753 42.8838 5.83899 42.3293 5.83899C41.7748 5.83899 41.3146 6.02753 40.9486 6.40459C40.5826 6.77057 40.3996 7.2419 40.3996 7.81859C40.3996 8.39528 40.5826 8.87216 40.9486 9.24923C41.3146 9.61521 41.7748 9.7982 42.3293 9.7982Z" fill="#1761FF"/>
                <Path d="M55.0077 5.54647C55.0077 5.73202 54.9302 5.90915 54.7939 6.0351L51.3606 9.20879C51.2494 9.31154 51.3221 9.4973 51.4735 9.4973H53.3025C54.3361 9.4973 55.174 10.3352 55.174 11.3688C55.174 11.7133 54.8947 11.9926 54.5502 11.9926H48.1872C47.8197 11.9926 47.5218 11.6947 47.5218 11.3272V10.1211C47.5218 9.93551 47.5993 9.75839 47.7355 9.63243L51.1689 6.45875C51.28 6.356 51.2073 6.17024 51.0559 6.17024H49.5596C48.526 6.17024 47.6881 5.33235 47.6881 4.29877C47.6881 3.95424 47.9674 3.67494 48.312 3.67494H54.3423C54.7097 3.67494 55.0077 3.97286 55.0077 4.34036V5.54647Z" fill="#1761FF"/>
                <Path d="M61.8121 4.6897C61.8338 4.6897 61.8538 4.67817 61.8647 4.65943L62.4298 3.6874C62.5776 3.4332 62.8747 3.30614 63.1606 3.37486L63.8991 3.55237C64.1981 3.62427 64.4089 3.89177 64.4089 4.19936V11.4682C64.4089 11.7758 64.1981 12.0433 63.8991 12.1152L63.1606 12.2927C62.8747 12.3614 62.5776 12.2343 62.4298 11.9801L61.8647 11.0081C61.8538 10.9894 61.8338 10.9778 61.8121 10.9778C61.7923 10.9778 61.7738 10.9875 61.7622 11.0035C61.4982 11.3688 61.1494 11.6652 60.7159 11.8928C60.2723 12.1257 59.7732 12.2421 59.2187 12.2421C58.1097 12.2421 57.1892 11.8373 56.4573 11.0277C55.7364 10.2182 55.376 9.16459 55.376 7.86704C55.376 6.58058 55.7309 5.52146 56.4406 4.6897C57.1615 3.84684 58.0875 3.42541 59.2187 3.42541C59.7732 3.42541 60.2723 3.54186 60.7159 3.77475C61.1494 4.00234 61.4982 4.29877 61.7622 4.66404C61.7738 4.68006 61.7923 4.6897 61.8121 4.6897ZM59.9174 9.81337C60.483 9.81337 60.9433 9.62484 61.2981 9.24777C61.6641 8.85961 61.8471 8.38828 61.8471 7.83377C61.8471 7.26817 61.6641 6.79683 61.2981 6.41977C60.9322 6.0427 60.4719 5.85417 59.9174 5.85417C59.3629 5.85417 58.9027 6.0427 58.5367 6.41977C58.1707 6.78575 57.9877 7.25708 57.9877 7.83377C57.9877 8.41046 58.1707 8.88734 58.5367 9.26441C58.9027 9.63038 59.3629 9.81337 59.9174 9.81337Z" fill="#1761FF"/>
              </Svg>

              {/* Slogan */}
              <Text style={{ fontSize: 8, fontWeight: 600, color: '#454545' }}>
                Ta'lim resurslari bazasi
              </Text>

              {/* Website */}
              <Text style={{ fontSize: 8, fontWeight: 600, color: '#1761FF', textAlign: 'right' }}>
                edubaza.uz
              </Text>
            </View>
          </View>
        </View>

        {/* Tasks */}
        {data.tasks.map((task, index) => (
          <TaskRenderer key={task.id} task={task} index={index} />
        ))}

        {/* Footer */}
        <Text style={commonStyles.footer}>
          Â© {new Date().getFullYear()} EduBaza.uz - Barcha huquqlar himoyalangan
        </Text>
      </Page>
    </Document>
  );
};
